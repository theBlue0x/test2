<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="0xlist: the decentralized marketplace on the Blue0x blockchain">
<title>0xlist: the decentralized marketplace on the Blue0x blockchain</title>
<link rel="stylesheet" href="../../css/styles.css">
<link rel="icon" type="image/x-icon" href="../../img/favicon.ico">
</head>
<body class="font-medium text-gray-700">
<div class="pt-3 w-full h-12 bg-gray-100 border-b border-gray-300 truncate">
<button class="px-2 ml-1 text-blue-600 bg-white rounded-full border border-gray-300 hover:underline" 
	onclick="window.location.href='../index.html'">0x
</button> 
<span id="city" class="text-blue-600 cursor-pointer" onclick="backToCity()"></span> >
<span id="type" class="text-blue-600 cursor-pointer" onclick="backToCity()"></span> >
<span id="category" class="text-blue-600 cursor-pointer" onclick="backToCity()"></span>
</div>
<div class="flex h-[calc(100dvh-48px)]">
    <nav class="hidden z-99 relative border-r border-gray-300 lg:flex" id="menu">
        <div class="flex flex-col m-2 mt-3 w-48">
        	<h2 class="text-xl" id="sideBarTitle">&nbsp;</h2>
            <div class="mt-6 ml-1 space-y-2 text-sm">
            	<input type="checkbox" name="checkbox" id="titlesOnly" class="cursor-pointer">
							<label for="titlesOnly" class="labelM">search titles only</label><br>

							<input type="checkbox" name="checkbox" id="hasImage" class="cursor-pointer">
							<label for="hasImage" class="labelM">has image</label><br>

							<input type="checkbox" name="checkbox" id="postedToday" class="cursor-pointer">
							<label for="postedToday" class="labelM">posted today</label><br>
            </div>
            <div class="mt-10 w-full text-xs">
            	<p>MILES FROM LOCATION</p>
            	<div class="flex inline-flex mt-1 space-x-2">
	            	<div class="w-3/5 h-7 border border-gray-300">
	            		<input type="text" id="distance" placeholder="miles" class="px-1 w-full h-full placeholder:px-1" autocomplete="off">
	            	</div>
	            	<div class="w-3/5 h-7 border border-gray-300">
	            		<input type="text" id="postalCode" placeholder="from zip" class="px-1 w-full h-full placeholder:px-1" autocomplete="off">
	            	</div>
	            </div>
            </div>
            <div class="mt-4 w-full text-xs">
            	<p>PRICE</p>
            	<div class="flex inline-flex mt-1 space-x-2">
	            	<div class="w-3/5 h-7 border border-gray-300">
	            		<input type="text" id="minPrice" placeholder="min" class="px-1 w-full h-full placeholder:px-1" autocomplete="off">
	            	</div>
	            	<div class="w-3/5 h-7 border border-gray-300">
	            		<input type="text" id="maxPrice" placeholder="max" class="px-1 w-full h-full placeholder:px-1" autocomplete="off">
	            	</div>
	            </div>
            </div>
            <div class="mt-8 w-full text-blue-600">
            	<div class="flex inline-flex space-x-2.5">
	            	<div class="w-3/5 border border-gray-300">
	            		<button class="py-1 px-6" onclick="reset()">reset</button>
	            	</div>
	            	<div class="w-3/5 border border-gray-300">
	            		<button class="py-1 px-6" onclick="getZips();showMenu()">apply</button>
	            	</div>
	            </div>
            </div>
            <div class="absolute bottom-2 ml-2">
            	<span id="state" class="flex items-center text-sm"><img class="mb-1 w-3 h-3 animate-spin" src="../../img/loader-black.svg"></span>
            </div>
        </div>
    </nav>
	<div class="overflow-y-scroll flex-1 pr-2 mt-2 ml-2 w-full">
			<div class="flex overflow-hidden relative items-center w-full h-11 bg-white">
	      <div class="lg:hidden mr-1 grid place-items-center w-11 h-full border border-gray-300 rounded cursor-pointer" onclick="showMenu()">
	        <img class="w-5 h-5" src="../../img/list2.svg">
	      </div>
	      <div class="grid place-items-center w-11 h-full text-gray-400 border border-gray-300 rounded-l">
	        <img class="w-5 h-5" src="../../img/search.svg">
	      </div>
	        <input class="pl-2 w-full h-full text-gray-700 border border-l-0 border-gray-300 rounded-r outline-none focus:outline-none" type="text" id="search" placeholder="search ..." /> 
	    </div>

	    <div id="dropdowns"><!---- hide for menu div -->
	    	<div class="flex inline-flex z-50 mt-2 w-full">
	        	<button onclick="showDropdown(1)" class="inline-flex relative py-1 px-3 text-blue-600 rounded border border-gray-300"><img class="mt-1 mr-2" src="../../img/images.svg">gallery&nbsp; <img class="mt-0.5 ml-0.5" src="../../img/chevron-down.svg"> </button>
	        	<div id="dropdown1" class="flex hidden absolute z-50 flex-col mt-9 text-blue-600 bg-white border border-gray-300">
				    <a class="py-1 px-4 mt-0.5 hover:bg-blue-300" href="#"><img class="inline-flex mr-2 mb-1" src="../../img/list.svg">list</a>
				    <a class="py-1 px-4 -ml-0.5 hover:bg-blue-300" href="#"><img class="inline-flex mr-2 mb-1" src="../../img/thumb.svg">thumb</a>
				    <a class="py-1 px-4 mb-1.5 hover:bg-blue-300" href=""><img class="inline-flex mr-2" src="../../img/images.svg">gallery</a>
				</div>
				<div class="z-50 ml-2">
					<button onclick="showDropdown(2)" class="inline-flex relative py-1 px-3 text-blue-600 rounded border border-gray-300">newest&nbsp;<img class="mt-0.5 ml-0.5" src="../../img/chevron-down.svg"> </button>
		        	<div id="dropdown2" class="flex hidden absolute z-50 flex-col text-blue-600 bg-white border border-gray-300">
		        		<a class="py-1 px-4 hover:bg-blue-300" href="#">newest</a>
					    <a class="py-1 px-4 hover:bg-blue-300" href="#">oldest</a>
					    <a class="py-1 px-4 hover:bg-blue-300" href="#">low to high</a>
					    <a class="py-1 px-4 mb-1 hover:bg-blue-300" href="#">high to low</a>
					</div>
				</div>
				<div class="pt-1.5 ml-4">
					<span class="text-xs md:text-base" id="totalListings"></span>
				</div>
			</div><!---- end hide for menu div -->
 		</div>

 		<div id="itemsDiv" class="grid relative grid-cols-1 gap-4 mt-2 mb-4 w-full md:grid-cols-2 lg:grid-cols-3">
 			<div id="itemsDivCenter" class="absolute left-0 flex h-[calc(50dvh)] w-full justify-center items-center">
 				<img class="w-6 h-6 animate-spin" src="../../img/loader-black.svg">
 			</div>
 		</div>
 	</div>
</div>
<script src="../../js/constants.js"></script>
<script>
const queryString = window.location.search
const urlParams = new URLSearchParams(queryString)
const city = urlParams.get("city")
document.getElementById("city").innerText = city
const currency = urlParams.get("currency")
let t
const section = urlParams.get("section")
if(section == "forSale") {
	t = "for sale"
} else {
	t = section 
}
document.getElementById("type").innerText = t

let category = urlParams.get("category")
if(category == "free"){
	category = "free stuff"
}
document.getElementById("category").innerText = category
document.getElementById("sideBarTitle").innerText = category
document.getElementById("search").placeholder = "search " + category
const tag = city + ',' + t + ',' + category

const params = new URLSearchParams({
	requestType: "searchDGSGoods",
	tag: tag
})
fetch(apiURL + params)
.then((response) => response.json())
.then((data) => {
let rows = ''
const goods = data.goods
document.getElementById("totalListings").innerText = goods.length + ' listings'
if(goods.length == 0) {
	document.getElementById("itemsDivCenter").innerHTML = 'No listings.'
}
for (var i = 0; i < goods.length; i++) {
const d = JSON.parse(goods[i].description)
let img = d.img1
if(d.img1 == ""){
img = '../../img/no-image.jpg'
}
const p = Number(d.price)
const price = p.toLocaleString('en-US', {maximumFractionDigits:8})
rows += '<div class="relative p-4 border border-gray-300 shadow-md cursor-pointer w-84 md:h-[332px]" onclick="showItem('+ goods[i].goods +'n)">'
rows += '<div class="absolute top-1 left-1 py-1 px-2 text-green-500 bg-white border border-gray-300">$'+ price + '</div>'
rows += '<div class="flex justify-center items-center w-full md:h-64"><img class="w-auto max-h-64" src="' + img + '"></div>'
rows += '<p class="mt-1 text-blue-600 md:mt-0.5">' + goods[i].name + '</p>'
rows += '<div class="inline-flex ml-1"><span class="text-sm text-gray-400">6h</span><span class="ml-4 text-sm text-gray-400">' + d.neighborhood + '</span></div>'
rows += '</div>'
document.getElementById("itemsDiv").innerHTML = rows
}})

function nodeState() {
const params2 = new URLSearchParams({
  requestType: 'getState'
})
fetch(apiURL + params2)
.then((response) => response.json())
.then((data) => {
  const blocks = data.numberOfBlocks
  const state = data.blockchainState
  const nodeStatus = "<span class='flex flex-shrink-0 w-2.5 h-2.5 text-sm bg-green-500 rounded-full me-1.5'></span>" + blocks
  document.getElementById("state").innerHTML = nodeStatus
})
.catch((error) => {
  document.getElementById('state').innerHTML = "<span class='text-red-500'>Offline</span>"
})}
nodeState()
setInterval(nodeState, 4000)

function reset() {
document.getElementById("titlesOnly").checked = false
document.getElementById("hasImage").checked = false
document.getElementById("postedToday").checked = false
document.getElementById("distance").value = ""
document.getElementById("postalCode").value = ""
document.getElementById("minPrice").value = "" 
document.getElementById("maxPrice").value = ""
}

function showDropdown(num) {
document.getElementById("dropdown" + num).classList.toggle("hidden")
}

function showItem(item) {
console.log(item)
window.location.href = '../item/?currency='+ currency + '&city=' + city + '&section=' + section + '&category=' + category + '&item=' + item
}

function backToCity() {
	window.location.href = '../city/?currency=' + currency + '&city=' + city
}

function getZips(){
let postalCode = document.getElementById("postalCode").value
let distance = document.getElementById("distance").value 

const requestOptions = {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({"zipCode": postalCode,"distance": distance}),
  redirect: "follow"
}

fetch("http://localhost:3000/distance", requestOptions)
  .then((response) => response.text())
  .then((result) => console.log(result))
  .catch((error) => console.error(error))
}

function showMenu() {
document.getElementById("menu").classList.toggle("hidden")
document.getElementById("dropdowns").classList.toggle("hidden")
document.getElementById("dropdowns").classList.toggle("lg:block")
}
</script>
</body>
</html>