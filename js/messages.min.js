function encryptNote(e,r,t){try{r=getEncryptionKeys(r,t);var y=encryptData(converters.stringToByteArray(e),r);return{message:converters.byteArrayToHexString(y.data),nonce:converters.byteArrayToHexString(y.nonce)}}catch(a){if(a.errorCode&&a.errorCode<5)throw a;throw console.log(a),{errorCode:5}}}function getPrivateKey(e){var r=simpleHash(converters.stringToByteArray(e));return converters.shortArrayToHexString(curve25519_clamp(converters.byteArrayToShortArray(r)))}function curve25519_clamp(e){return e[0]&=65528,e[15]&=32767,e[15]|=16384,e}function getEncryptionKeys(e,r){if(!e.sharedKey){if(!e.privateKey){if(!r){if(rememberPassword)r=_password;else throw{errorCode:1}}e.privateKey=converters.hexStringToByteArray(getPrivateKey(r))}if(e.publicKey)"string"==typeof e.publicKey&&(e.publicKey=converters.hexStringToByteArray(e.publicKey));else{if(!e.account)throw{errorCode:2};try{e.publicKey=converters.hexStringToByteArray(getPublicKey(e.account,!0))}catch(t){if(new NxtAddress().set(e.account))throw{errorCode:4};throw{errorCode:3}}}}return e}function encryptData(e,r){r.nonce=getRandomBytes(32),r.sharedKey||(r.sharedKey=getSharedSecret(r.privateKey,r.publicKey));var t=pako.gzip(new Uint8Array(e)),y=aesEncrypt(t,r);return{nonce:r.nonce,data:y}}function decryptData(e,r){r.sharedKey||(r.sharedKey=getSharedSecret(r.privateKey,r.publicKey));var t,y=aesDecrypt(e,r),a=new Uint8Array(y.decrypted);return!1!==r.isCompressed&&(a=pako.inflate(a)),{message:t=!1!==r.isText?converters.byteArrayToString(a):converters.byteArrayToHexString(a),sharedKey:converters.byteArrayToHexString(y.sharedKey)}}function aesEncrypt(e,r){var t,y=getRandomBytes(16),a=converters.byteArrayToWordArray(e);t=r.sharedKey?r.sharedKey.slice(0):getSharedSecret(r.privateKey,r.publicKey);for(var o=0;o<32;o++)t[o]^=r.nonce[o];var n=CryptoJS.SHA256(converters.byteArrayToWordArray(t)),c=CryptoJS.AES.encrypt(a,n,{iv:converters.byteArrayToWordArray(y)}),i=converters.wordArrayToByteArray(c.iv),s=converters.wordArrayToByteArray(c.ciphertext);return i.concat(s)}function aesDecrypt(e,r){if(e.length<16||e.length%16!=0)throw{name:"invalid ciphertext"};var t,y,a=converters.byteArrayToWordArray(e.slice(0,16)),o=converters.byteArrayToWordArray(e.slice(16));if(t=r.sharedKey?r.sharedKey.slice(0):getSharedSecret(r.privateKey,r.publicKey),r.nonce){for(var n=0;n<32;n++)t[n]^=r.nonce[n];y=CryptoJS.SHA256(converters.byteArrayToWordArray(t))}else y=converters.byteArrayToWordArray(t);var c=CryptoJS.lib.CipherParams.create({ciphertext:o,iv:a,key:y}),i=CryptoJS.AES.decrypt(c,y,{iv:a});return{decrypted:converters.wordArrayToByteArray(i),sharedKey:converters.wordArrayToByteArray(y)}}function getSharedSecret(e,r){return converters.shortArrayToByteArray(curve25519_(converters.byteArrayToShortArray(e),converters.byteArrayToShortArray(r),null))}function getRandomBytes(e){if(!window.crypto&&!window.msCrypto&&!crypto)throw{errorCode:-1};var r=new Uint8Array(e);return window.crypto?window.crypto.getRandomValues(r):window.msCrypto?window.msCrypto.getRandomValues(r):r=crypto.randomBytes(e),r}function decryptNote(e,r,t){try{if(!r.sharedKey){if(!r.privateKey){if(!t){if(rememberPassword)t=_password;else if(_decryptionPassword)t=_decryptionPassword;else throw{errorCode:1}}r.privateKey=converters.hexStringToByteArray(getPrivateKey(t))}if(!r.publicKey){if(!r.account)throw{errorCode:2};r.publicKey=converters.hexStringToByteArray(getPublicKey(r.account,!0))}}return r.nonce&&(r.nonce=converters.hexStringToByteArray(r.nonce)),decryptData(converters.hexStringToByteArray(e),r)}catch(y){if(y.errorCode&&y.errorCode<3)throw y;throw{errorCode:3}}}function encryptMessage(e,r,t){var y=encryptNote(e,{publicKey:converters.hexStringToByteArray(t)},r);return{encryptedMessageData:y.message,encryptedMessageNonce:y.nonce,messageToEncryptIsText:"true"}}function decryptMessage(e){return decryptNote(e.attachment.encryptedMessage.data,{nonce:e.attachment.encryptedMessage.nonce,account:e.sender,isText:!0,isCompressed:!0})}